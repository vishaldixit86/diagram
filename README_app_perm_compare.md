# App + Permission SHOULD-HAVE vs DOES-HAVE Comparator

This script compares:
- **SHOULD-HAVE** (persona-based access mapping Excel)
vs
- **DOES-HAVE** (BRID-based access export)
and produces **Matched / Missing / Excess** Application+Permission entries per HR record.

---

## Files included

- `app_perm_compare.py` — main script (function + optional CLI)
- Output (generated by you): `app_perm_shd_vs_does.xlsx` (or any name you pass)

---

## Install

```bash
pip install pandas openpyxl
```

(If your DOES-HAVE file is large, you can also install `pyarrow`, but not required.)

---

## Inputs & Expected Columns

### 1) SHOULD-HAVE Excel (multi-sheet)
Must contain at least:
- `PERSONA`
- an application column (first found among):
  - `UPDATED APPLICATION NAME`, `APPLICATION NAME`, `APP`, `APPLICATION`
- a permission/entitlement column (first found among):
  - `PERMISSION`, `ENTITLEMENTS`, `APP PERMISSION`, `PRIVILEGE`

If permission cell contains multiple values (comma/newline/semicolon/pipe), the script splits them.

### 2) DOES-HAVE export (txt/csv)
Default delimiter is `|` (pipe). Must contain:
- `BRID`
- an application column (first found among):
  - `APPLICATION`, `APP`, `APP_NAME`, `APPLICATION NAME`
- a permission column (first found among):
  - `PERMISSION`, `ENTITLEMENT`, `PRIVILEGE`, `ROLE`, `ACCESS`

### 3) HR Excel
Must contain:
- `BRID`
and either:
- `SUGGESTED PERSONA` (already filled), **OR**
- `COST CENTER - ID` + `MANAGEMENT LEVEL` plus a mapping file (below)

### 4) Optional: Costcenter->Persona mapping Excel
Used when HR does NOT already have persona.
Mapping file should have:
- `COSTCENTER_MANAGEMENT-LEVEL` (example: `12345_MANAGER`)
- `PERSONA`

---

## How matching is done

Each record is normalized (trim, collapse spaces) and optionally uppercased.

A token is created like:

```
APP_NAME :: PERMISSION
```

Then per HR row:
- `MATCHED_APP_PERM` = intersection(does, should)
- `MISSING_APP_PERM` = should - does
- `EXCESS_APP_PERM`  = does - should

---

## Run using CLI

```bash
python app_perm_compare.py ^
  --shd-have "C:\path\persona_access_permission_mapping_training_v2.1.xlsx" ^
  --hr "C:\path\Headcount_USCB_US_INDIA_Colleagues_11.5.2025.xlsx" ^
  --does-have "C:\path\01_app_access_export.txt" ^
  --out "C:\path\app_perm_shd_vs_does.xlsx"
```

### Filter only certain SHOULD-HAVE sheets (example: COOPAL)

```bash
python app_perm_compare.py ^
  --shd-have "C:\path\persona_access_permission_mapping_training_v2.1.xlsx" ^
  --hr "C:\path\Headcount.xlsx" ^
  --does-have "C:\path\01_app_access_export.txt" ^
  --out "C:\path\output.xlsx" ^
  --shd-sheet-contains "COOPAL"
```

### Provide Costcenter->Persona mapping (if HR doesn’t already have persona)

```bash
python app_perm_compare.py ^
  --shd-have "C:\path\persona_access_permission_mapping_training_v2.1.xlsx" ^
  --hr "C:\path\Headcount.xlsx" ^
  --does-have "C:\path\01_app_access_export.txt" ^
  --out "C:\path\output.xlsx" ^
  --map-xlsx "C:\path\BRID_COSTCENTER_PERSONA_MAPPING_ANALYSIS.xlsx" ^
  --map-sheet "persona_map"
```

---

## Use as a function in Jupyter

```python
from app_perm_compare import build_app_perm_should_vs_does_report

df_final = build_app_perm_should_vs_does_report(
    shd_have_xlsx=r"C:\path\persona_access_permission_mapping_training_v2.1.xlsx",
    hr_xlsx=r"C:\path\Headcount.xlsx",
    does_have_access_file=r"C:\path\01_app_access_export.txt",
    costcenter_persona_map_xlsx=r"C:\path\BRID_COSTCENTER_PERSONA_MAPPING_ANALYSIS.xlsx",
    costcenter_persona_map_sheet="persona_map",
    shd_sheet_filter_contains="COOPAL",
    out_xlsx=r"C:\path\app_perm_shd_vs_does.xlsx"
)
df_final.head()
```

---

## Output

The output Excel contains 3 sheets:
1) `HR_APP_PERM_SHD_vs_DOES` (final comparison)
2) `SHD_HAVE_RAW` (filtered + standardized SHOULD-HAVE rows)
3) `DOES_HAVE_RAW` (standardized DOES-HAVE rows)

Key columns in final sheet:
- `SHD_HAVE_APP_PERM_SET`
- `DOES_HAVE_APP_PERM_SET`
- `MATCHED_APP_PERM`
- `MISSING_APP_PERM`
- `EXCESS_APP_PERM`

---

## Common fixes

1) **Script says DOES-HAVE missing columns**
   - Check your DOES-HAVE export header names and ensure they include BRID + app + permission.
   - If your delimiter is not `|`, pass `--does-delim ","` (or correct delimiter).

2) **Too many mismatches due to casing/spaces**
   - The script already trims and collapses spaces and uppercases by default.
   - If you want case-sensitive matching, edit `app_norm_upper=False` and `perm_norm_upper=False` in the function call.

3) **Permission column contains JSON or complex structures**
   - If permissions are JSON/list strings, tell me the exact format; we can add a parser.

